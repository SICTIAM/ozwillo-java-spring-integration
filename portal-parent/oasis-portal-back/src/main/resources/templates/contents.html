<span class="text-center">
<h2>Gestion des contenus</h2>
</span>

<div class="row">
    <div class="col-sm-2 text-center dash-switcher">
        <ul id="dashboard_list" class="nav nav-pills nav-stacked text-left">
            <li th:each="info : ${contentList}" th:class="${currentContent.id == info.contentItem.id ? 'active' : ''}">
                <a th:href="${'/contents/edit/' + info.contentItem.id}">
                    <span class="badge pull-right" th:if="${info.missingTranslations.size() != 0}"
                    	th:text="${info.missingTranslations.size()}"></span>
                    <span th:text="${info.contentItem.id}"></span>
                </a>
            </li>
        </ul>
        <form role="form" id="create-dash" method="POST" action="#" th:action="@{/contents/create}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="form-group">
                <label for="dashboardname" th:text="#{action.create}">+ create new</label>
                <input type="text" name="contentId" id="contentId" class="form-control"/>
            </div>
            <div class="text-right">
                <input type="image" src="../public/img/icon/plus.png" th:src="@{/img/icon/plus.png}" id="create-dashboard-plus" />
            </div>
        </form>
    </div>
    <div class="col-sm-8">
        <div class="form-buttons">
            <input id="save" type="button" class="btn btn-primary" th:value="#{action.save}"/>
            <input id="delete" type="button" class="btn btn-default" th:value="#{action.delete}" th:if="${currentContent.id != 'home'}" />
            <ul class="nav navbar-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle btn btn-ozwillo btn-noborder" data-toggle="dropdown">
                        <span class="badge" th:if="${missingTranslations.size()}" th:text="${missingTranslations.size()}"></span>
                        <span id="selectedLanguage" th:text="${currentLanguage.name}">English</span>
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu" >
                        <li th:each="lang : ${languages}">
                            <a thref="#" th:onclick="'javascript:switchLanguage(\'' + ${lang.locale} + '\',\'' + ${lang.name} + '\')'">
                                <span class="badge pull-right" th:if="${missingTranslations.indexOf(lang.locale.language) != -1}">!</span>
                                <span th:text="${lang.name}">Blablaish</span>
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <div id="epiceditor"></div>
    </div>
</div>

<!-- XXX Organize code better -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="/js/epiceditor.min.js"></script>
<script type="text/javascript" th:inline="javascript">

var contentItem = /*[[${currentContent}]]*/ {};
var currentLocale = /*[[${defaultLanguage.locale.language}]]*/ 'en';
var currentLanguageName = /*[[${defaultLanguage.name}]]*/ 'English';


// Markdown editor init
var editor = new EpicEditor({
    basePath: '',
    clientSideStorage: false,
    focusOnLoad: true,
    theme: {
        base: '/css/epiceditor/base/epiceditor.css',
        editor: '/css/epiceditor/editor/epic-light.css',
        preview: '/css/epiceditor/preview/github.css'
    },
    autogrow: {
        minHeight: 300,
        maxHeight: false,
        scroll: true,
    },
    button: {
        bar: "show"
    }
}).load();

// Prevent from accidentally leaving
editor.getElement('editor').addEventListener('keydown', function() {
    window.onbeforeunload = window.onbeforeunload || function() {
        return "[[#{backend.leavewithoutsaving}]]";
    }
});

// Save button behavior
$('#save').click(function() {
    $this = $(this);
    $this.addClass('btn-disabled');
    localSave();

    $.ajax({url: "/contents/save",
        type: "POST",
        data: JSON.stringify(contentItem),
        contentType: "application/json; charset=utf-8",
        dataType: "html",
        success: function (fragment) {
            window.onbeforeunload = null;
            location.reload();
        }
    });
})

// Delete button behavior
$('#delete').click(function() {
    $this = $(this);
    if (confirm("[[#{action.delete.confirm}]]")) {
        $this.addClass('pending');
        
        $.ajax({url: "/contents/delete/" + contentItem.id,
            type: "POST",
            dataType: "html",
            success: function (fragment) {
                window.onbeforeunload = null;
                location.href = "/contents/edit/home";
            }
        });
    }
})

// Choose default language
switchLanguage(currentLocale, currentLanguageName, true);

function localSave() {
    contentItem.content[currentLocale] = editor.exportFile();
}

function switchLanguage(locale, languageName, doNotSave) {
    if (!doNotSave) {
      localSave();

      $.ajax({url: "/contents/defaultlanguage",
          type: "POST",
          data: locale,
          contentType: "application/json; charset=utf-8",
          dataType: "html"
      });
    }
    
    editor.importFile('content', contentItem.content[locale]);
    $('#selectedLanguage').html(languageName);
    
    currentLocale = locale;
    currentLanguageName = locale;
}
</script>